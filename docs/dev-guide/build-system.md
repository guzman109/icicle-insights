# Build System Guide

This project uses **CMake** with **Ninja** as the build system and **Conan 2.x** for C++ dependency management.

## Overview

```
conanfile.py          # Declares dependencies, generates CMake config files
       │
       ▼
   conan install      # Downloads/builds deps, generates CMake files
       │
       ▼
CMakeLists.txt        # Finds deps via find_package(), defines build
       │
       ▼
   cmake (Ninja)      # Generates build.ninja
       │
       ▼
   ninja              # Builds the executable (via cmake --build)
```

## Files

### `conanfile.py`

The Conan recipe that manages C++ dependencies.

```python
class IcicleInsightsConan(ConanFile):
    settings = "os", "compiler", "build_type", "arch"
```

**`settings`** - Build matrix variables that affect how dependencies are built.

#### `requirements()`

Declares dependencies from [Conan Center](https://conan.io/center):

| Package | Version | Purpose |
|---------|---------|---------|
| `asio` | 1.36.0 | Async I/O, networking |
| `openssl` | 3.6.0 | TLS/SSL cryptography |
| `glaze` | 7.0.0 | JSON serialization, HTTP routing |
| `libpq` | 17.7 | PostgreSQL C client |
| `libpqxx` | 7.10.5 | PostgreSQL C++ client |
| `spdlog` | 1.17.0 | Logging |

#### `configure()`

Sets options on dependencies:

```python
self.options["libpq/*"].with_ssl = True   # Enable SSL for PostgreSQL
self.options["libpq/*"].shared = True     # Use shared libs (avoid symbol conflicts)
self.options["openssl/*"].shared = True
```

#### `generate()`

Produces build system integration files:

- **`CMakeToolchain`** - Generates `conan_toolchain.cmake` for CMake with compiler settings and build configuration
- **`CMakeDeps`** - Generates CMake config files (`*Config.cmake`) so `find_package()` can find packages

```python
from conan.tools.cmake import CMakeToolchain, CMakeDeps

def generate(self):
    tc = CMakeToolchain(self)
    tc.generate()

    deps = CMakeDeps(self)
    deps.generate()
```

---

### `CMakeLists.txt`

The CMake build definition.

```cmake
cmake_minimum_required(VERSION 3.25)
project(icicle-insights VERSION 0.1.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
```

#### Dependencies

Each `find_package()` call looks up the CMake config files generated by Conan:

```cmake
find_package(asio REQUIRED)
find_package(glaze REQUIRED)
find_package(PostgreSQL REQUIRED)
find_package(libpqxx REQUIRED)
find_package(spdlog REQUIRED)
find_package(OpenSSL REQUIRED)
```

**Note**: The libpq package is found via `find_package(PostgreSQL)`, not `find_package(libpq)`.

#### Executable

Defines the build target:

```cmake
add_executable(icicle-insights
    src/insights.cpp
    src/git/router.cpp
    src/server/server.cpp
)

target_include_directories(icicle-insights PRIVATE
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/include
)

target_link_libraries(icicle-insights PRIVATE
    asio::asio
    glaze::glaze
    libpq::libpq
    libpqxx::pqxx
    spdlog::spdlog
    OpenSSL::SSL
    OpenSSL::Crypto
)

target_compile_definitions(icicle-insights PRIVATE
    GLZ_ENABLE_SSL
)
```

- **Sources**: Listed explicitly in `add_executable()` (no globbing)
- **Include paths**: `src/` and `include/` via `target_include_directories()`
- **Linking**: CMake target names from Conan (e.g., `asio::asio`, `libpq::pq`)
- **Compile definitions**: `GLZ_ENABLE_SSL` enables SSL support in glaze

---

## Adding a New Dependency

1. **Add to `conanfile.py`** in `requirements()`:
   ```python
   self.requires("package-name/1.0.0")
   ```

2. **Add to `CMakeLists.txt`**:
   ```cmake
   find_package(package-name REQUIRED)
   ```

   And add it to the executable's `target_link_libraries()`:
   ```cmake
   target_link_libraries(icicle-insights PRIVATE
       package-name::package-name
       # ... other libraries
   )
   ```

3. **Rebuild**:
   ```bash
   just deps        # Re-run Conan to fetch new dependency
   just reconfigure # Reconfigure CMake to pick up new package
   just build       # Build
   ```

## Adding a New Source File

1. Add the file path to the `add_executable()` sources in `CMakeLists.txt`
2. Run `just reconfigure` then `just build`

## Troubleshooting

### "Could not find package"

CMake can't find the package config file. Check:
- Did `conan install` complete successfully?
- Is the package name in `find_package()` correct? (check `build/` for `*Config.cmake` files)
- Is the toolchain file being passed to CMake? (verify `-DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake`)

### "Symbol not found" / linking errors

Often caused by static/shared library mismatches. Check `configure()` in `conanfile.py` - you may need to set `shared = True` for conflicting packages.

### Target name errors

Conan-generated CMake targets follow the pattern `package::component`. If you get link errors, check the exact target names in `build/*Targets.cmake` files.

Common patterns:
- `asio::asio`
- `libpq::libpq` (found via `find_package(PostgreSQL)`)
- `libpqxx::pqxx`
- `OpenSSL::SSL` and `OpenSSL::Crypto`
- `spdlog::spdlog`

### Stale build

Run `just clean-build` for a full rebuild from scratch.
